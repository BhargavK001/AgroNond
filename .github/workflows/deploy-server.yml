# Deploy to EC2 on push to main
name: Deploy Server to EC2

on:
  push:
    branches:
      - main
    paths:
      - 'apps/server/**'  # Only trigger when server code changes

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |

            set -e  # Stop on error
            
            PROJECT_DIR=~/AgroNond
            SERVER_DIR=apps/server

            echo "üöÄ Starting Deployment..."
            
            # 1. Navigate to project
            cd $PROJECT_DIR || exit 1

            # 2. SAVE STATE (Checkpoint)
            OLD_COMMIT=$(git rev-parse HEAD)
            echo "üìç Checkpoint saved: $OLD_COMMIT"

            # 3. CLEAN & PULL
            echo "üßπ Cleaning local changes..."
            git reset --hard HEAD
            
            echo "‚¨áÔ∏è Pulling latest code..."
            if ! git pull origin main; then
              echo "‚ùå Git Pull Failed. No changes made."
              exit 1
            fi

            # 4. INSTALL & BUILD (With Rollback)
            echo "üì¶ Installing server dependencies..."
            cd $SERVER_DIR || exit 1
            
            if ! npm install; then
              echo "‚ö†Ô∏è NPM Install Failed! Rolling back..."
              cd $PROJECT_DIR
              git reset --hard $OLD_COMMIT
              
              # Restore old dependencies
              cd $SERVER_DIR
              npm install
              
              echo "‚úÖ Rolled back to stable version."
              exit 1
            fi

            # 5. RESTART
            echo "üîÑ Restarting Service..."
            pm2 restart all
            
            echo "‚úÖ Deployment Successful!"

